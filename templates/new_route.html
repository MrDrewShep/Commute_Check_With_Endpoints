<!DOCTYPE html>
<html>

<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    #map {
      margin-top: 0px;
      margin-left: 100px;
      height: 500px;
      width: 700px;
    }

    #myform {
      margin-top: 100px;
      margin-left: 100px;
    }

    #registration_form {
      display: table;
    }

    #registration_form p {
      display: table-row;
    }

    #registration_form label {
      display: table-cell;
      padding-right: 10px;
      text-align: right;
    }

    #registration_form input {
      display: table-cell;
    }

    .texttip {
      color: grey;
      font-style: italic;
    }

    .controls {
      width: 300px;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <p>
    <ul>
      <li>Step 1: Type your start and end locations</li>
      <li>Step 2: Drag the map to match your preferred route. This is the route against which the service will check for faster alternatives.</li>
      <li>Step 3: Fill out the remainder of the form.</li>
    </ul>
  </p>
  <div id="map"></div>
  <div class="myform">
    <!--removed $event from the function call, which was preventing the function from running-->
    <form id="registration_form" method="post" onsubmit="submit_preferred_route()" action="http://localhost:5000/route/new" target="_blank">
      <p>
        <label for="">Start location:</label>
        <select name="start_location_type" id="">
          <option value="home">Home</option>
          <option value="work" selected>Work</option>
        </select>
        <input type="text" class="controls" placeholder="Start typing here" id="pac-input-start" name="start_location">
      </p>
      <p>
        <label for="">End location:</label>
        <select name="end_location_type" id="">
          <option value="home" selected>Home</option>
          <option value="work">Work</option>
        </select>
        <input type="text" class="controls" placeholder="Start typing here" id="pac-input-end" name="end_location">
      </p>
      <br>
      <p>
        <label for="">Run at:</label>
        <input type="time" name="local_run_time" id="">
        <select name="local_timezone_offset">
            <option timeZoneId="5" gmtAdjustment="GMT-08:00" useDaylightTime="1" value="-8">(GMT-08:00) Pacific Time (US & Canada)</option>
            <option timeZoneId="9" gmtAdjustment="GMT-07:00" useDaylightTime="1" value="-7">(GMT-07:00) Mountain Time (US & Canada)</option>
            <option timeZoneId="11" gmtAdjustment="GMT-06:00" useDaylightTime="1" value="-6">(GMT-06:00) Central Time (US & Canada)</option>
            <option timeZoneId="15" gmtAdjustment="GMT-05:00" useDaylightTime="1" value="-5" selected>(GMT-05:00) Eastern Time (US & Canada)</option>
        </select>
      </p>
      <p>
        <label for="">On these days of the week:</label>
        <input type="checkbox" value="Sunday" name="Sunday"> Sunday <br>
        <input type="checkbox" value="Monday" name="Monday"> Monday <br>
        <input type="checkbox" value="Tuesday" name="Tuesday"> Tuesday <br>
        <input type="checkbox" value="Wednesday" name="Wednesday"> Wednesday <br>
        <input type="checkbox" value="Thursday" name="Thursday"> Thursday <br>
        <input type="checkbox" value="Friday" name="Friday"> Friday <br>
        <input type="checkbox" value="Saturday" name="Saturday"> Saturday <br>  
      </p>
      <p>
        <label for="">Delay tolerance:</label>
        <select name="delay_tolerance" id="">
          <option value="1">1 min</option>
          <option value="2">2 min</option>
          <option value="3">3 min</option>
          <option value="4">4 min</option>
          <option value="5">5 min</option>
          <option value="6">6 min</option>
          <option value="7">7 min</option>
          <option value="8">8 min</option>
          <option value="9">9 min</option>
          <option value="10">10 min</option>
          <option value="11">11 min</option>
          <option value="12">12 min</option>
          <option value="13">13 min</option>
          <option value="14">14 min</option>
          <option value="15">15 min</option>
        </select>
      </p>
      <p>
        <label for=""></label>
        <label for="" style="text-align:left;"><font class="texttip">Alerts are only sent if an alternate route exists which is faster than your preferred route + your delay tolerance.</font></label>
      </p>
      <br>
      <p>
        <label for=""></label>
        <input type="submit" value="Sign me up">
      </p>
      <input type="hidden" id="preferred_route_info" name="google_response">
    </form>
    <br>
    <br>
  </div>
  <script>
    
    var preferred_route;
    var autocomplete;

    function initAutocomplete() {
      // Create the autocomplete object, restricting the search predictions to
      // geographical location types.
      autocomplete_start = new google.maps.places.Autocomplete(
        document.getElementById('pac-input-start'), { types: ['geocode'] });
      autocomplete_end = new google.maps.places.Autocomplete(
        document.getElementById('pac-input-end'), { types: ['geocode'] });

      // Avoid paying for data that you don't need by restricting the set of
      // place fields that are returned to just the address components.
      autocomplete_start.setFields(['address_component']);
      autocomplete_end.setFields(['address_component']);

      // When the user selects an address from the drop-down, populate the
      // address fields in the form.
      // autocomplete.addListener('place_changed', fillInAddress);
    }

    function initMap() {
      var directionsService = new google.maps.DirectionsService();
      var directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: true
      });
      var indy = new google.maps.LatLng(39.768776, -86.157875);
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: indy
      });

      directionsRenderer.setMap(map);

      var onChangeHandler = function () {
        calculateAndDisplayRoute(directionsService, directionsRenderer);
      };
      directionsRenderer.addListener('directions_changed', function() {
          onDrag(directionsRenderer.getDirections());
        });
      document.getElementById('pac-input-start').addEventListener('change', onChangeHandler);
      document.getElementById('pac-input-end').addEventListener('change', onChangeHandler);
    }
    
    
    var onDrag = function (my_directions) {
      preferred_route = my_directions;

      // console.log("found")
      // console.log(preferred_route);
    };



    function calculateAndDisplayRoute(directionsService, directionsRenderer) {
      directionsService.route(
        {
          origin: { query: document.getElementById('pac-input-start').value },
          destination: { query: document.getElementById('pac-input-end').value },
          travelMode: 'DRIVING'
        },
        function (response, status) {
          if (status === 'OK') {
            preferred_route = response;
            // document.getElementById('response').textContent = JSON.stringify(response);
            // console.log(preferred_route);
            directionsRenderer.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
    }

    function submit_preferred_route(e) {
      let hiddenbox = document.getElementById('preferred_route_info');
      // hiddenbox.value = preferred_route;  for some reason it wasn't working to pass the object through in the http request
      hiddenbox.value = JSON.stringify(preferred_route);
      console.log(preferred_route);
      e.preventDefault();
      // still need to figure out how to do preventDefault
    };


    function initialize() {
      initMap();
      initAutocomplete();
    };

  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATihl_Z2QdHLLLNQiSXzHI6QBzafumoKw&libraries=places&callback=initialize"
    async defer></script>
</body>

</html>